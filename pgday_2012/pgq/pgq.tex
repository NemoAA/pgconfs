%%% PGCONF.EU 2012, Prague
%%%
%%% Lightning Talk: PGQ Cooperative Consumers

\documentclass{beamer}

\usepackage{beamerthemesplit}
%% \usetheme{Warsaw}
\usetheme{Frankfurt}
\beamertemplatetransparentcovered

\title{PGQ Cooperative Consumers}
\author{Dimitri Fontaine \& Marko Kreen}
\date{25 Oct. 2012}
\logo{\includegraphics[height=0.4cm]{2ndQuadrant-cross.png}}

\begin{document}

\frame{\titlepage}

\section{Batches needs}

\begin{frame}[fragile]
  \frametitle{Database processing oriented batches}

\begin{columns}[c]

\column{.5\textwidth}

If you're managing an \textit{OLTP} system, you probably have out of line
processing to get done, and probably are using cron batches and home made
\textit{daemons}.

\pause
\begin{example}
\begin{verbatim}
  while True: 
    // what a nice daemon!
\end{verbatim}
\end{example}

\pause
\column{.5\textwidth} 
  Of course you want them 
  \begin{itemize}
   \item reliable, easy to monitor and control (logs)
   \item out of a developer \texttt{screen} session
   \item easy to stop \& restart
   \item to reuse existing models
  \end{itemize}

\end{columns}
\end{frame}

\section{PGQ features}

\begin{frame}[fragile]
  \frametitle{Queueing with \textit{PGQ}}

  \center{\textit{Off-line} processing is better done with \texttt{PGQ}}

\begin{columns}[c]
\column{.6\textwidth} 

  \begin{itemize}
   \item Mainly written in \texttt{PLpgSQL} (and \texttt{C})
   \item Client \textit{API} for \texttt{python}
   \item and \texttt{PHP}
   \item some work is happening for \texttt{Java}
   \item \textbf{Cooperative Worker} (Skytools 3)
  \end{itemize}  

  \center{\texttt{PGQ}: Stable, Reliable, Easy to monitor}

\column{.4\textwidth}
\includegraphics[height=9em]{drop-queue.png}
\end{columns}
\end{frame}

\section{Mix and Match}

\frame{
  \frametitle{Implementing a daemon atop PGQ}

  Skytools comes with two \textit{middleware} for you to abuse to make
  daemons with, the \texttt{python} \textit{DBScript} facility and the
  \texttt{PHP} \textit{libphp-pgq} one.

\begin{columns}[c]
\column{.6\textwidth} 

  \begin{itemize}
    \item<1-> \texttt{apt-get install skytools3python-skytools3 python-pgq3}
    \item<2-> \texttt{apt-get install skytools-ticker3}
    \item<3-> \texttt{apt-get install postgresql-9.1-pgq3}
    \item<3-> \texttt{CREATE EXTENSION pgq;}
  \end{itemize}

\column{.4\textwidth}
\includegraphics[height=9em]{pydebian.png}
\end{columns}
}

\frame{
  \frametitle{PGQ SQL API}

  PGQ is bundled as a PostgreSQL Extension, with a nice API for you to use:

  \begin{itemize}
    \item \texttt{select pgq.create\_queue('LogEvent');}
    \item \texttt{select pgq.insert\_event('LogEvent', 'data', 'DataFor123');}
    \item \texttt{select pgq.register\_consumer('LogEvent', 'TestConsumer');}
    \item \texttt{select pgq.next\_batch('LogEvent', 'TestConsumer'); [into batch\_id]}
    \item \texttt{select * from pgq.get\_batch\_events(batch\_id);}
    \item \texttt{select pgq.finish\_batch(batch\_id)}
  \end{itemize}

  \center{Already implemented for you in the python and PHP libs.}
}

\begin{frame}[fragile]
  \frametitle{Several Kinds of Consumers}

  Some consumers will only offload local processing, some are maintaining
  \textit{remote} data when processing events from the local queue.

  \begin{itemize}
   \item \textbf{PGQ Consumer}
   \item     \textit{every consumer gets the same batches}
   \item \textbf{PGQ Cooperative Consumer}
   \item     \textit{any batch is only seen by a single consumer}
  \end{itemize}
\end{frame}

\section{Going Live!}

\begin{frame}[fragile]
  \frametitle{Monitoring Cooperative Consumers}

\begin{center} 
\includegraphics[height=2.1in]{pg_queue_fotolog_q_photo-day.png}
\end{center} 
\end{frame}

\begin{frame}[fragile]
  \frametitle{Managing production daemons}

  We have several \texttt{PGQ} daemons in our live environments, monitored
  with \texttt{nagios} and \texttt{munin}, and we're able to easily control
  them. It's much better than previously.

\begin{columns}[c]
\column{.5\textwidth}
  \begin{example}[PHP daemon management example]
  \begin{verbatim}
    # mydaemon.php start
    # mydaemon.php status
    # mydaemon.php logmore

    # mydaemon.php kill
  \end{verbatim}
  \end{example}
\column{.5\textwidth} 
\begin{center} 
\includegraphics[height=1.3in]{pgq.png}
\end{center} 
\end{columns}
\end{frame}

\end{document}
